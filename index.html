<!-- index.html (FULL DROP-IN) — Launcher page with Equipment Image upload (GitHub/localStorage)
     ADD: Phenolic setup (color code dropdown + FED FROM / EQUIP ID / FEEDS) saved into nexus_meta_${eq} -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NEXUS</title>

<style>
  :root{
    --bg:#b60000;
    --panel:rgba(255,255,255,0.20);
    --panel2:rgba(0,0,0,0.35);
    --line:rgba(255,255,255,0.18);
    --ink:#fff;
    --btn-bg:#0a0f24;
    --btn-txt:#3ecbff;
    --accent:#00c2ff;
  }
  *{box-sizing:border-box;}
  html,body{margin:0;font-family:Arial,Helvetica,sans-serif;color:var(--ink);background:var(--bg);}
  body{
    background-image:url("transformer.jpg");
    background-repeat:no-repeat;
    background-position:center center;
    background-size:cover;
    background-attachment:fixed;
  }

  .topbar{
    max-width:1200px;
    margin:16px auto 0;
    padding:0 18px;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
  }
  .brand{ font-weight:900; font-size:44px; letter-spacing:.02em; text-shadow:0 6px 22px rgba(0,0,0,.35); }
  .tagline{ margin-top:6px; font-weight:800; opacity:.95; text-shadow:0 6px 22px rgba(0,0,0,.35); }
  .ready-pill{
    margin-top:4px;
    padding:6px 14px;
    border-radius:999px;
    background:rgba(0,0,0,0.25);
    border:1px solid rgba(255,255,255,0.20);
    font-weight:900;
    font-size:14px;
    align-self:flex-start;
  }

  .wrap{
    max-width:1200px;
    margin:12px auto 40px;
    padding:0 18px;
  }
  .shell{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:18px;
    backdrop-filter:blur(10px);
    padding:18px;
  }

  .grid{
    display:grid;
    grid-template-columns: 1.05fr 0.95fr;
    gap:16px;
    margin-top:12px;
  }
  @media (max-width: 980px){
    .grid{ grid-template-columns: 1fr; }
    .brand{ font-size:36px; }
  }

  .card{
    background:rgba(0,0,0,0.20);
    border:1px solid rgba(255,255,255,0.18);
    border-radius:18px;
    padding:16px;
  }
  .card h3{
    margin:0 0 12px;
    font-size:14px;
    letter-spacing:.12em;
    text-transform:uppercase;
    font-weight:900;
    opacity:.95;
  }

  .field{ margin:12px 0; }
  label{ display:block; font-weight:900; font-size:13px; margin:0 0 6px; opacity:.95; }
  input, select{
    width:100%;
    padding:14px 14px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.20);
    background:rgba(255,255,255,0.92);
    color:#111;
    font-weight:800;
    font-size:16px;
    outline:none;
  }

  .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
  .btn{
    padding:12px 16px;
    font-size:15px;
    font-weight:900;
    border-radius:999px;
    color:var(--btn-txt);
    background:var(--btn-bg);
    border:2px solid var(--accent);
    cursor:pointer;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    user-select:none;
    gap:10px;
    min-width: 170px;
  }
  .btn.secondary{
    background: rgba(0,0,0,0.18);
    color:#fff;
    border:2px solid rgba(255,255,255,0.30);
  }

  .hint{
    margin-top:12px;
    padding:12px 12px;
    border-radius:14px;
    background:rgba(0,0,0,0.18);
    border:1px solid rgba(255,255,255,0.16);
    font-weight:800;
    font-size:12px;
    opacity:.95;
    line-height:1.35;
  }
  code{
    background:rgba(0,0,0,0.25);
    border:1px solid rgba(255,255,255,0.18);
    padding:2px 6px;
    border-radius:8px;
    color:#fff;
  }

  /* ===== Equipment Image block ===== */
  .img-block{ margin-top:12px; }
  .img-status{ margin-top:8px; font-size:12px; font-weight:900; opacity:.9; line-height:1.35; }
  #nexusEquipImagePreview{
    display:none;
    margin-top:10px;
    width:100%;
    max-height:220px;
    object-fit:cover;
    border-radius:12px;
    box-shadow:0 10px 22px rgba(0,0,0,.28);
    border:1px solid rgba(255,255,255,0.18);
  }
  .img-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .mini-btn{
    padding:10px 14px;
    border-radius:999px;
    font-weight:900;
    cursor:pointer;
    border:2px solid rgba(255,255,255,0.35);
    background: rgba(0,0,0,0.20);
    color:#fff;
  }

  /* ===== NEXUS: Phenolic setup preview pill ===== */
  .phenolic-mini{
    margin-top:10px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.18);
    background: rgba(0,0,0,0.18);
    font-weight:900;
    font-size:12px;
    line-height:1.35;
  }
  .phenolic-swatch{
    display:inline-block;
    width:14px;
    height:14px;
    border-radius:4px;
    margin-right:8px;
    vertical-align:-2px;
    border:1px solid rgba(255,255,255,0.28);
  }

  .footer{
    max-width:1200px;
    margin:22px auto 0;
    padding:18px 12px;
    text-align:center;
    font-size:12px;
    font-weight:900;
    color:rgba(255,255,255,0.85);
    background:rgba(0,0,0,0.35);
    border-top:1px solid rgba(255,255,255,0.18);
    border-radius:0 0 18px 18px;
  }
</style>

<link rel="stylesheet" href="assets/css/nexus-core.css">
</head>

<body>

<div class="topbar">
  <div>
    <div class="brand">NEXUS</div>
    <div class="tagline">Mission Critical Construction Data Centralization</div>
  </div>
  <div class="ready-pill">Ready</div>
</div>

<div class="wrap">
  <div class="shell">
    <div class="grid">
      <!-- LEFT: OPEN EQUIPMENT -->
      <div class="card">
        <h3>Open Equipment</h3>

        <div class="field">
          <label for="eqInput">Equipment ID</label>
          <input id="eqInput" type="text" placeholder="TR-001" value="TR-001" />
        </div>

        <!-- NEW: Equipment Image Upload -->
        <div class="img-block">
          <label for="nexusEquipImageInput">Equipment Image</label>
          <input id="nexusEquipImageInput" type="file" accept="image/*" capture="environment" />
          <img id="nexusEquipImagePreview" alt="Equipment image preview" />
          <div id="nexusEquipImageStatus" class="img-status"></div>
          <div class="img-actions">
            <button id="nexusEquipImageClearBtn" class="mini-btn" type="button">Clear Image</button>
          </div>
        </div>

        <div class="field">
          <label for="bldgInput">Building #</label>
          <input id="bldgInput" type="text" placeholder="Bldg-01" value="Bldg-01" />
        </div>

        <div class="field">
          <label for="phaseSelect">Phase</label>
          <select id="phaseSelect">
            <option value="">Select...</option>
            <option value="Phase 1">Phase 1</option>
            <option value="Phase 2">Phase 2</option>
            <option value="Phase 3">Phase 3</option>
          </select>
        </div>

        <div class="field">
          <label for="podSelect">POD</label>
          <select id="podSelect">
            <option value="">Select...</option>
            <option value="POD A">POD A</option>
            <option value="POD B">POD B</option>
            <option value="POD C">POD C</option>
          </select>
        </div>

        <div class="field">
          <label for="procoreEquipUrl">Procore Equipment URL</label>
          <input id="procoreEquipUrl" type="text" placeholder="Paste Procore equipment link" />
        </div>

        <div class="field">
          <label for="procoreEnergUrl">Procore Energization URL</label>
          <input id="procoreEnergUrl" type="text" placeholder="Paste Procore energization link" />
        </div>

        <!-- =========================
             NEXUS: Phenolic Setup (ADD)
             ========================= -->
        <div class="field">
          <label for="phenolicColorSelect">Phenolic Color Code (per chart)</label>
          <select id="phenolicColorSelect">
            <option value="">Select...</option>
            <!-- Reserved -->
            <option value="bms_blue">BLUE — BMS (Gravoply #17353)</option>
            <option value="fire_red">RED — Fire Alarm (Gravoply #17506)</option>

            <!-- Buses -->
            <option value="bus_a_orange">ORANGE — A Bus (Gravoply #17047)</option>
            <option value="bus_b_green">GREEN — B Bus (Gravoply #17442)</option>
            <option value="bus_d_cyan">CYAN — D Bus (Gravoly #45901)</option>
            <option value="bus_e_yellow_white">YELLOW (white lettering) — E Bus (Gravoply #17366)</option>
            <option value="catcher_pink">PINK — CATCHER / C Bus (Gravoply #32725)</option>

            <!-- Other -->
            <option value="nonpod_gray">GRAY — Non-Pod Specific (Gravoply #29584)</option>
            <option value="global_black">BLACK — Global / Room Designation (Gravoply #17319)</option>
            <option value="house_brown">BROWN — House Services (Gravoply #17388)</option>

            <!-- EPMS special -->
            <option value="epms_yellow_black">YELLOW (black lettering) — EPMS (Gravoply #17366)</option>
          </select>

          <div id="phenolicMiniPreview" class="phenolic-mini" style="display:none;">
            <span class="phenolic-swatch" id="phenolicSwatch"></span>
            <span id="phenolicMiniText"></span>
          </div>
        </div>

        <div class="field">
          <label for="phenolicFedFrom">Phenolic — FED FROM</label>
          <input id="phenolicFedFrom" type="text" placeholder="CUPP 1.3A" />
        </div>

        <div class="field">
          <label for="phenolicEquipId">Phenolic — Equipment ID (line 2)</label>
          <input id="phenolicEquipId" type="text" placeholder="USB 1.3B-MCBC1" />
        </div>

        <div class="field">
          <label for="phenolicFeeds">Phenolic — FEEDS</label>
          <input id="phenolicFeeds" type="text" placeholder="BUS C1" />
        </div>
        <!-- =========================
             /NEXUS: Phenolic Setup (ADD)
             ========================= -->

        <div class="btnrow">
          <button class="btn" id="openEquipmentBtn" type="button">Open Equipment Page</button>
          <button class="btn secondary" id="generateQrBtn" type="button">Generate QR</button>
          <a class="btn secondary" id="equipmentStepsBtn" href="#">Equipment Steps</a>
        </div>

        <div class="hint">
          QR codes should encode a URL like: <code>equipment.html?eq=TR-001</code><br>
          Scanning a QR should land on the equipment page and keep <code>eq</code> through every task.
        </div>
      </div>

      <!-- RIGHT: QUICK LINKS -->
      <div class="card">
        <h3>Quick Links</h3>
        <div class="btnrow">
          <button class="btn secondary" id="qrGeneratorLink" type="button">QR Generator</button>
          <button class="btn secondary" id="scanQrLink" type="button">Scan QR</button>
          <button class="btn secondary" id="submissionHistoryLink" type="button">Submission History</button>
        </div>

        <div class="hint">
          If you arrived here from a QR code (with <code>?eq=</code>), you will be redirected to the correct equipment page automatically.
        </div>
      </div>
    </div>

    <div class="footer">
      © 2026 NEXUS Data Science — Built for ACE Electric — All Rights Reserved
    </div>
  </div>
</div>

<script src="assets/js/nexus-core.js"></script>
<script src="assets/js/nexus-firebase-bridge.js"></script>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const incomingEq = (qs.get("eq") || "").trim();
  if (incomingEq){
    // If you want auto-redirect when landing with ?eq=, enable this:
    // location.href = `equipment.html?eq=${encodeURIComponent(incomingEq)}`;
  }

  const eqInput = document.getElementById("eqInput");
  const bldgInput = document.getElementById("bldgInput");
  const phaseSelect = document.getElementById("phaseSelect");
  const podSelect = document.getElementById("podSelect");
  const procoreEquipUrl = document.getElementById("procoreEquipUrl");
  const procoreEnergUrl = document.getElementById("procoreEnergUrl");

  // NEXUS: phenolic fields
  const phenolicColorSelect = document.getElementById("phenolicColorSelect");
  const phenolicFedFrom = document.getElementById("phenolicFedFrom");
  const phenolicEquipId = document.getElementById("phenolicEquipId");
  const phenolicFeeds = document.getElementById("phenolicFeeds");
  const phenolicMiniPreview = document.getElementById("phenolicMiniPreview");
  const phenolicSwatch = document.getElementById("phenolicSwatch");
  const phenolicMiniText = document.getElementById("phenolicMiniText");

  const openEquipmentBtn = document.getElementById("openEquipmentBtn");
  const generateQrBtn = document.getElementById("generateQrBtn");
  const equipmentStepsBtn = document.getElementById("equipmentStepsBtn");

  const qrGeneratorLink = document.getElementById("qrGeneratorLink");
  const scanQrLink = document.getElementById("scanQrLink");
  const submissionHistoryLink = document.getElementById("submissionHistoryLink");

  function getEq(){ return (eqInput.value || "").trim(); }
  function metaKey(eq){ return `nexus_meta_${eq || "NO_EQ"}`; }

  function loadMeta(eq){
    try{
      const raw = localStorage.getItem(metaKey(eq));
      if (raw) return JSON.parse(raw);
    }catch(e){}
    return {};
  }

  // ===== NEXUS: Phenolic color code table (per spec) =====
  const PHENOLIC_CODES = {
    bms_blue:             { label:"BLUE — BMS",                    bg:"#1b4fd6", fg:"#ffffff", gravoply:"#17353" },
    fire_red:             { label:"RED — Fire Alarm",              bg:"#c01616", fg:"#ffffff", gravoply:"#17506" },

    bus_a_orange:         { label:"ORANGE — A Bus",                bg:"#f57c00", fg:"#ffffff", gravoply:"#17047" },
    bus_b_green:          { label:"GREEN — B Bus",                 bg:"#168a3a", fg:"#ffffff", gravoply:"#17442" },
    bus_d_cyan:           { label:"CYAN — D Bus",                  bg:"#00bcd4", fg:"#ffffff", gravoply:"#45901" },
    bus_e_yellow_white:   { label:"YELLOW (white) — E Bus",        bg:"#ffd400", fg:"#ffffff", gravoply:"#17366" },
    catcher_pink:         { label:"PINK — CATCHER / C Bus",        bg:"#e91e63", fg:"#ffffff", gravoply:"#32725" },

    nonpod_gray:          { label:"GRAY — Non-Pod Specific",        bg:"#6f7b86", fg:"#ffffff", gravoply:"#29584" },
    global_black:         { label:"BLACK — Global / Room",         bg:"#111111", fg:"#ffffff", gravoply:"#17319" },
    house_brown:          { label:"BROWN — House Services",        bg:"#6b3f1a", fg:"#ffffff", gravoply:"#17388" },

    epms_yellow_black:    { label:"YELLOW (black) — EPMS",         bg:"#ffd400", fg:"#111111", gravoply:"#17366" }
  };

  function getPhenolicEquipIdDefault(){
    // If user hasn't entered a custom phenolic equip id, default to eq
    const v = (phenolicEquipId?.value || "").trim();
    if (v) return v;
    const eq = getEq();
    return eq || "";
  }

  function refreshPhenolicMini(){
    if (!phenolicMiniPreview || !phenolicColorSelect) return;

    const key = (phenolicColorSelect.value || "").trim();
    const spec = PHENOLIC_CODES[key];

    if (!key || !spec){
      phenolicMiniPreview.style.display = "none";
      return;
    }

    phenolicMiniPreview.style.display = "block";
    phenolicSwatch.style.background = spec.bg;
    phenolicSwatch.style.borderColor = "rgba(255,255,255,0.28)";
    phenolicMiniText.textContent = `${spec.label} • Gravoply ${spec.gravoply} • Text: ${spec.fg === "#111111" ? "BLACK" : "WHITE"}`;
  }

  function saveMeta(eq){
    if(!eq) return;

    // IMPORTANT: merge with existing meta so we don't overwrite other stored fields
    const prev = loadMeta(eq) || {};

    const phenolic = {
      colorCode: (phenolicColorSelect?.value || "").trim(),
      fedFrom: (phenolicFedFrom?.value || "").trim(),
      equipId: (phenolicEquipId?.value || "").trim(),
      feeds: (phenolicFeeds?.value || "").trim()
    };

    const meta = {
      ...prev,
      building: (bldgInput.value || "").trim(),
      phase: (phaseSelect.value || "").trim(),
      pod: (podSelect.value || "").trim(),
      procoreEquipUrl: (procoreEquipUrl.value || "").trim(),
      procoreEnergizationUrl: (procoreEnergUrl.value || "").trim(),
      phenolic: {
        ...(prev.phenolic || {}),
        ...phenolic
      },
      updatedAt: Date.now()
    };

    localStorage.setItem(metaKey(eq), JSON.stringify(meta));
    refreshPhenolicMini();
  }

  function loadMetaIntoFields(eq){
    const meta = loadMeta(eq);

    if (meta.building != null) bldgInput.value = meta.building || bldgInput.value;
    if (meta.phase != null) phaseSelect.value = meta.phase || "";
    if (meta.pod != null) podSelect.value = meta.pod || "";
    if (meta.procoreEquipUrl != null) procoreEquipUrl.value = meta.procoreEquipUrl || "";
    if (meta.procoreEnergizationUrl != null) procoreEnergUrl.value = meta.procoreEnergizationUrl || "";

    // phenolic
    const p = meta.phenolic || {};
    if (p.colorCode != null && phenolicColorSelect) phenolicColorSelect.value = p.colorCode || "";
    if (p.fedFrom != null && phenolicFedFrom) phenolicFedFrom.value = p.fedFrom || "";
    if (p.equipId != null && phenolicEquipId) phenolicEquipId.value = p.equipId || "";
    if (p.feeds != null && phenolicFeeds) phenolicFeeds.value = p.feeds || "";

    // If no saved phenolic equipId, default it to eq (without forcing over user input)
    if (phenolicEquipId && !(phenolicEquipId.value || "").trim()){
      phenolicEquipId.value = eq || "";
    }

    refreshPhenolicMini();
  }

  // persist meta on changes
  [
    eqInput,bldgInput,phaseSelect,podSelect,procoreEquipUrl,procoreEnergUrl,
    phenolicColorSelect, phenolicFedFrom, phenolicEquipId, phenolicFeeds
  ].forEach(el=>{
    if (!el) return;
    el.addEventListener("change", ()=>{
      const eq = getEq();
      saveMeta(eq);
    });
    el.addEventListener("input", ()=>{
      const eq = getEq();
      if(eq) saveMeta(eq);
    });
  });

  // when eq changes, load meta for that eq
  eqInput.addEventListener("change", ()=>{
    loadMetaIntoFields(getEq());
    // also refresh image preview state
    loadPreviewForCurrentEq();

    // keep steps link aligned to current eq (no other behavior change)
    equipmentStepsBtn.href = `equipment_steps.html?eq=${encodeURIComponent(getEq() || "TR-001")}`;
  });
  eqInput.addEventListener("input", ()=>{
    // refresh image preview state as they type
    loadPreviewForCurrentEq();

    // keep steps link aligned to current eq as they type
    equipmentStepsBtn.href = `equipment_steps.html?eq=${encodeURIComponent(getEq() || "TR-001")}`;
  });

  // buttons
  openEquipmentBtn.addEventListener("click", ()=>{
    const eq = getEq();
    if(!eq) return alert("Enter Equipment ID first.");
    // If phenolic equip id is blank, default it to eq before saving
    if (phenolicEquipId && !(phenolicEquipId.value || "").trim()){
      phenolicEquipId.value = eq;
    }
    saveMeta(eq);
    location.href = `equipment.html?eq=${encodeURIComponent(eq)}`;
  });

  generateQrBtn.addEventListener("click", ()=>{
    const eq = getEq();
    if(!eq) return alert("Enter Equipment ID first.");
    if (phenolicEquipId && !(phenolicEquipId.value || "").trim()){
      phenolicEquipId.value = eq;
    }
    saveMeta(eq);
    location.href = `qr.html?eq=${encodeURIComponent(eq)}`;
  });

  equipmentStepsBtn.href = `equipment_steps.html?eq=${encodeURIComponent(getEq() || "TR-001")}`;

  qrGeneratorLink.addEventListener("click", ()=> location.href = "qr.html");
  scanQrLink.addEventListener("click", ()=> location.href = "scan_qr.html");
  submissionHistoryLink.addEventListener("click", ()=> location.href = "submission_history.html");

  // ===== Equipment Image (GitHub-first localStorage) =====
  const fileInput = document.getElementById("nexusEquipImageInput");
  const preview = document.getElementById("nexusEquipImagePreview");
  const status = document.getElementById("nexusEquipImageStatus");
  const clearBtn = document.getElementById("nexusEquipImageClearBtn");

  function equipKey(eq){ return `nexus_equipment_${eq}`; }

  function readEquip(eq){
    try{ return JSON.parse(localStorage.getItem(equipKey(eq)) || "{}"); }
    catch(e){ return {}; }
  }

  function writeEquip(eq, patch){
    const cur = readEquip(eq);
    const merged = { ...cur, ...patch, _updatedAt: Date.now() };
    localStorage.setItem(equipKey(eq), JSON.stringify(merged));
    return merged;
  }

  function setStatus(msg){ status.textContent = msg || ""; }

  function show(url){
    if(!url) return;
    preview.src = url;
    preview.style.display = "block";
  }

  function hide(){
    preview.removeAttribute("src");
    preview.style.display = "none";
  }

  function fileToDataUrl(file){
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(String(r.result || ""));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  function loadPreviewForCurrentEq(){
    const eq = getEq();
    if(!eq){
      hide();
      setStatus("Enter Equipment ID to save an image.");
      return;
    }
    const rec = readEquip(eq);
    if(rec.imageDataUrl){
      show(rec.imageDataUrl);
      setStatus("Loaded saved image for this equipment (GitHub mode: this device).");
    } else {
      hide();
      setStatus("No image saved yet for this equipment.");
    }
  }

  fileInput.addEventListener("change", async (e)=>{
    const eq = getEq();
    if(!eq){ alert("Enter Equipment ID first."); fileInput.value=""; return; }
    const file = e.target.files && e.target.files[0];
    if(!file) return;

    setStatus("Saving image…");
    const dataUrl = await fileToDataUrl(file);
    writeEquip(eq, { imageDataUrl: dataUrl });
    show(dataUrl);
    setStatus("Saved. This will show on form.html for the same ?eq= value.");
  });

  clearBtn.addEventListener("click", ()=>{
    const eq = getEq();
    if(!eq) return;
    const cur = readEquip(eq);
    delete cur.imageDataUrl;
    cur._updatedAt = Date.now();
    localStorage.setItem(equipKey(eq), JSON.stringify(cur));
    fileInput.value = "";
    hide();
    setStatus("Cleared image for this equipment (this device).");
  });

  // Firebase-ready hook later
  window.NEXUS_setEquipmentImageUrlFromFirebase = function(url){
    const eq = getEq();
    if(!eq || !url) return;
    writeEquip(eq, { imageDataUrl: url });
    show(url);
    setStatus("Image set from Firebase (and cached locally).");
  };

  // init: if URL has eq, set it; load meta + image
  if (incomingEq){
    eqInput.value = incomingEq;
  }
  loadMetaIntoFields(getEq());
  loadPreviewForCurrentEq();
  refreshPhenolicMini();
})();
</script>

</body>
</html>
