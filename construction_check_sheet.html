<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Construction Check Sheet</title>

  <!-- Global NEXUS -->
  <link rel="stylesheet" href="assets/css/nexus-core.css" />
  <script defer src="assets/js/nexus-core.js"></script>
  <script defer src="assets/js/nexus-firebase-bridge.js"></script>

  <style>
    /* ===== table behavior ===== */

    .table-wrap{
      overflow:auto;
      max-height:75vh;
    }

    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      font-size:13px;
    }

    th, td{
      border:1px solid #ddd;
      padding:6px 8px;
      min-width:110px;
      vertical-align:top;
    }

    /* sticky header */
    th{
      position:sticky;
      top:0;
      background:#f2f2f2;
      z-index:5;
    }

    /* editable cells */
    td[contenteditable]{
      white-space:pre-wrap;
      word-break:break-word;
      min-height:28px;
    }

    /* auto grow */
    td[contenteditable]:focus{
      outline:2px solid #4caf50;
      background:#f6fff6;
    }

    /* changed highlight */
    td.changed{
      background:#fff9c4;
    }

    /* lock mode */
    .locked td[contenteditable]{
      background:#f7f7f7;
      pointer-events:none;
    }

    /* toolbar */
    .toolbar{
      display:flex;
      gap:8px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }

    .toolbar button{
      padding:6px 10px;
      font-weight:600;
      cursor:pointer;
    }

    .status{
      margin-left:auto;
      font-size:12px;
      font-weight:700;
      align-self:center;
    }

    /* mobile stack */
    @media (max-width: 768px){
      td, th{
        min-width:80px;
        font-size:12px;
      }
    }

    /* print friendly */
    @media print{
      .toolbar, .back-link{
        display:none;
      }
      .table-wrap{
        max-height:none;
        overflow:visible;
      }
    }
  </style>
</head>

<body class="nexus-bg">
<div class="page-shell">

  <div class="back-link">
    <a id="backBtn" href="equipment.html">‚Üê Back to Equipment</a>
  </div>

  <div class="card">
    <h1>Construction Check Sheet</h1>
    <h3 id="equipmentLabel"></h3>

    <!-- ===== Toolbar ===== -->
    <div class="toolbar">
      <button id="lockBtn">üîí Lock</button>
      <button id="exportJson">Export JSON</button>
      <button id="exportCsv">Export CSV/Excel</button>
      <button onclick="window.print()">Print/PDF</button>
      <button id="clearBtn">Clear</button>
      <span id="saveStatus" class="status">Saved</span>
    </div>

    <div class="table-wrap">
      <table id="sheet">
        <tbody id="constructionBody">

          <!-- Sticky title row -->
          <tr>
            <th colspan="9">LV Transformer 001</th>
          </tr>

          <!-- ======= KEEP ALL YOUR ROWS EXACTLY AS THEY ARE BELOW ======= -->
          <!-- (paste your full existing rows here unchanged) -->

        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ===============================
   EQUIPMENT ROUTING
================================= */
const params = new URLSearchParams(window.location.search);
const eq = params.get("eq") || "default";

document.getElementById("equipmentLabel").textContent =
  eq ? "Equipment: " + eq : "";

document.getElementById("backBtn").href =
  "equipment.html" + (eq ? "?eq=" + encodeURIComponent(eq) : "");


/* ===============================
   SAVE SYSTEM (local + firebase ready)
================================= */

const SAVE_KEY = "construction:" + eq;
const statusEl = document.getElementById("saveStatus");
const body = document.getElementById("constructionBody");

const cells = () => [...body.querySelectorAll("td[contenteditable]")];

function snapshot(){
  const data = {};
  cells().forEach(td=>{
    const key = td.dataset.r + ":" + td.dataset.c;
    data[key] = td.textContent;
  });
  return data;
}

function apply(data){
  cells().forEach(td=>{
    const key = td.dataset.r + ":" + td.dataset.c;
    td.textContent = data[key] || "";
  });
}

function saveLocal(){
  localStorage.setItem(SAVE_KEY, JSON.stringify(snapshot()));
  statusEl.textContent = "Saved";
}

function loadLocal(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(raw) apply(JSON.parse(raw));
}

/* Firebase hook placeholder */
function saveFirebase(data){
  if(window.nexusFirebaseSave){
    window.nexusFirebaseSave("construction", eq, data);
  }
}

function saveAll(){
  const data = snapshot();
  saveLocal();
  saveFirebase(data);
}

/* autosave */
let timer;
function queueSave(){
  statusEl.textContent = "Saving‚Ä¶";
  clearTimeout(timer);
  timer = setTimeout(saveAll, 400);
}

/* ===============================
   EDIT BEHAVIOR
================================= */

cells().forEach(td=>{
  td.addEventListener("input", ()=>{
    td.classList.add("changed");
    queueSave();
  });

  /* Tab / Enter navigation */
  td.addEventListener("keydown", e=>{
    if(e.key==="Enter"){
      e.preventDefault();
      const next = td.parentElement.nextElementSibling?.querySelector("td[contenteditable]");
      next?.focus();
    }
  });
});

/* ===============================
   LOCK / UNLOCK
================================= */

let locked=false;
const lockBtn = document.getElementById("lockBtn");

lockBtn.onclick = ()=>{
  locked=!locked;
  document.getElementById("sheet").classList.toggle("locked", locked);
  lockBtn.textContent = locked ? "üîì Unlock" : "üîí Lock";
};

/* ===============================
   EXPORT
================================= */

document.getElementById("exportJson").onclick = ()=>{
  const blob = new Blob([JSON.stringify(snapshot(),null,2)],{type:"application/json"});
  download(blob,"construction.json");
};

document.getElementById("exportCsv").onclick = ()=>{
  const rows=[...body.querySelectorAll("tr")];
  const csv = rows.map(r=>[...r.children].map(c=>`"${c.textContent.replace(/"/g,'""')}"`).join(",")).join("\n");
  download(new Blob([csv]),"construction.csv");
};

function download(blob,name){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
}

/* ===============================
   CLEAR
================================= */

document.getElementById("clearBtn").onclick = ()=>{
  if(!confirm("Clear all data?")) return;
  cells().forEach(td=>td.textContent="");
  saveAll();
};

/* ===============================
   INIT
================================= */

loadLocal();
</script>

</body>
</html>
