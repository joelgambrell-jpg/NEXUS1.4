<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Construction Check Sheet</title>

  <!-- Keep your site core hooks (no behavior removed) -->
  <link rel="stylesheet" href="assets/css/nexus-core.css" />
  <script defer src="assets/js/nexus-core.js"></script>
  <script defer src="assets/js/nexus-firebase-bridge.js"></script>

  <style>
    :root{
      /* Correct assets */
      --bg-img: url("assets/img/transformer.jpg");
      --logo-img: url("assets/img/nexus.png");

      /* Paper-white content */
      --paper: rgba(255,255,255,.94);
      --paper-2: rgba(255,255,255,.98);
      --ink: #111318;
      --muted-ink: rgba(17,19,24,.70);

      /* UI */
      --border: rgba(17,19,24,.12);
      --border-2: rgba(17,19,24,.18);
      --shadow: 0 16px 48px rgba(0,0,0,.28);

      --thead: rgba(10,12,16,.92);
      --thead-2: rgba(10,12,16,.78);
      --row: rgba(255,255,255,.86);
      --row-2: rgba(250,250,250,.92);

      --accent: #00b3ff;
      --ok: #25c06d;
      --warn: #d97706; /* readable on white */
      --bad: #dc2626;

      --handoff: rgba(46, 204, 113, .18);
      --handoff-border: rgba(46, 204, 113, .35);
    }

    /* Background like your other pages */
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
      min-height: 100vh;
      background: #000;
      background-image: var(--bg-img);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    /* Blur overlay (matches your other pages feel) */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(7px);
      -webkit-backdrop-filter: blur(7px);
      z-index: -1;
    }

    .page-shell{
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px 16px 44px;
    }

    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 10px 12px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.20);
      border-radius: 14px;
      box-shadow: var(--shadow);
      color: #fff;
    }

    .topbar-left{
      display:flex;
      align-items:center;
      gap:12px;
      flex: 1 1 auto;
      min-width: 0;
      flex-wrap: wrap;
    }

    .logo{
      width: 110px;
      height: 44px;
      background-image: var(--logo-img);
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center left;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,.55));
      flex: 0 0 auto;
    }

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.26);
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 800;
      letter-spacing:.2px;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(0,0,0,.34); }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      border-color: rgba(0,179,255,.55);
      background: rgba(0,179,255,.22);
    }
    .btn.good{
      border-color: rgba(46,204,113,.55);
      background: rgba(46,204,113,.22);
    }

    .title-wrap{
      display:flex;
      flex-direction: column;
      gap:2px;
      min-width: min(520px, 100%);
    }
    .page-title{
      margin:0;
      font-size: 28px;
      line-height: 1.1;
      font-weight: 900;
      text-shadow: 0 10px 30px rgba(0,0,0,.55);
      cursor: default;
      user-select: none;
      color: #fff;
    }
    .subtitle{
      margin:0;
      color: rgba(255,255,255,.82);
      font-weight: 800;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Paper-white card */
    .card{
      margin-top: 18px;
      background: var(--paper);
      border: 1px solid rgba(255,255,255,.28);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .section-head{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 14px;
      background: rgba(0,0,0,.06);
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }
    .section-head h2{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
      color: var(--ink);
      font-weight: 900;
    }

    .grid{
      display:grid;
      gap: 12px;
      padding: 14px;
    }
    .grid.cols-4{ grid-template-columns: repeat(4, minmax(0, 1fr)); }

    .field{
      display:flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }
    .field label{
      font-weight: 900;
      color: rgba(17,19,24,.86);
      font-size: 13px;
      letter-spacing: .2px;
    }

    .input, .textarea{
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border-2);
      background: rgba(255,255,255,.98);
      color: var(--ink);
      padding: 11px 12px;
      font-weight: 800;
      outline: none;
      box-sizing: border-box;
    }
    .textarea{
      resize: vertical;
      min-height: 44px;
      line-height: 1.25;
      font-weight: 750;
      overflow-wrap: anywhere; /* prevent overflow */
      word-break: break-word;
    }
    .input::placeholder, .textarea::placeholder{ color: rgba(17,19,24,.45); font-weight: 800; }

    .muteline{
      padding: 0 14px 14px;
      color: var(--muted-ink);
      font-weight: 800;
      font-size: 12px;
    }

    /* Table */
    .table-wrap{
      padding: 14px;
      overflow: auto;
    }
    table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 980px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
    }

    thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: var(--thead);
      color: #fff;
      text-align: left;
      padding: 12px 10px;
      font-size: 14px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      white-space: nowrap;
    }

    thead tr:nth-child(2) th{
      background: var(--thead-2);
      font-size: 12px;
      letter-spacing:.2px;
    }

    tbody td{
      border-bottom: 1px solid var(--border);
      padding: 10px;
      vertical-align: top;
      background: var(--row);
    }
    tbody tr:nth-child(even) td{ background: var(--row-2); }

    /* Column sizing (desktop) */
    .col-num{ width: 54px; font-weight: 900; }
    .col-item{ width: 44%; }
    .col-notes{ width: 24%; }
    .col-sign{ width: 120px; }
    .col-date{ width: 160px; }
    .col-actions{ width: 60px; text-align:center; }

    /* Editable item cell - WRAP & NO OVERFLOW */
    .cell-edit{
      border: 1px solid transparent;
      border-radius: 10px;
      padding: 10px 10px;
      outline: none;
      background: rgba(0,0,0,.03);
      font-weight: 900;
      color: var(--ink);
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
      line-height: 1.25;
      min-height: 44px;
      box-sizing: border-box;
    }
    .cell-edit:focus{
      border-color: rgba(0,179,255,.55);
      box-shadow: 0 0 0 3px rgba(0,179,255,.16);
      background: rgba(0,179,255,.06);
    }

    /* Notes field - ensure it cannot overlap */
    .cell-note .textarea{
      background: rgba(0,0,0,.02);
      border-color: var(--border-2);
      font-weight: 750;
      box-sizing: border-box;
      max-width: 100%;
    }

    .small{
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border-2);
      background: rgba(0,0,0,.02);
      color: var(--ink);
      font-weight: 900;
      width: 100%;
      outline:none;
      box-sizing: border-box;
      min-width: 0;
    }
    .small:focus{
      border-color: rgba(0,179,255,.55);
      box-shadow: 0 0 0 3px rgba(0,179,255,.16);
    }

    .handoff td{
      background: var(--handoff) !important;
      border-bottom: 1px solid var(--handoff-border);
    }
    .handoff .handoff-label{
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: .5px;
      color: #0c3a1f;
      background: rgba(0,0,0,.02);
    }

    .section-row td{
      background: rgba(0,0,0,.06) !important;
      font-weight: 950;
    }

    /* Changed + invalid indicators */
    .changed{
      outline: 2px solid rgba(217,119,6,.35);
      box-shadow: 0 0 0 3px rgba(217,119,6,.12);
    }
    .invalid{
      outline: 2px solid rgba(220,38,38,.55) !important;
      box-shadow: 0 0 0 3px rgba(220,38,38,.14) !important;
    }

    .action-btn{
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border-2);
      background: rgba(0,0,0,.04);
      color: var(--ink);
      cursor:pointer;
      font-weight: 950;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .action-btn:hover{ background: rgba(0,0,0,.08); }
    .action-btn.add{ border-color: rgba(46,204,113,.55); background: rgba(46,204,113,.14); }
    .action-btn.del{ border-color: rgba(220,38,38,.55); background: rgba(220,38,38,.10); }

    .foreman-only{ display: none; }
    .is-foreman .foreman-only{ display: inline-flex; }

    /* === MOBILE: no overlaps; stack row cards cleanly === */
    @media (max-width: 900px){
      .grid.cols-4{ grid-template-columns: 1fr 1fr; }
      table{ min-width: 0; }

      thead{ display:none; }
      tbody, tr, td{ display:block; width:100%; }

      tbody tr{
        border: 1px solid var(--border);
        border-radius: 14px;
        margin-bottom: 12px;
        overflow:hidden;
        background: #fff;
      }

      tbody td{
        border-bottom: 1px solid var(--border);
        background: #fff;
      }

      tbody td::before{
        content: attr(data-label);
        display:block;
        font-size: 12px;
        letter-spacing:.2px;
        font-weight: 900;
        color: rgba(17,19,24,.70);
        margin-bottom: 6px;
      }

      /* Make inputs full width; prevent “side-by-side” squeezing that causes overlap */
      .small, .textarea, .cell-edit{
        width: 100%;
        max-width: 100%;
      }

      .col-actions{ text-align:left; }

      /* Better mobile header */
      .page-title{ font-size: 24px; }
      .logo{ width: 96px; height: 40px; }
      .subtitle{ white-space: normal; }
    }

    /* Print/PDF friendly */
    @media print{
      body{ background: #fff !important; color:#000 !important; }
      body::before{ display:none !important; }
      .topbar{ display:none !important; }
      .card{ box-shadow:none !important; background:#fff !important; border:0 !important; }
      .section-head{ background:#f2f2f2 !important; color:#000 !important; }
      table{ background:#fff !important; border:1px solid #bbb !important; }
      tbody td, thead th{ color:#000 !important; }
      .cell-edit, .small, .textarea{ background:#fff !important; color:#000 !important; border:1px solid #bbb !important; box-shadow:none !important; }
      .action-btn{ display:none !important; }
    }
  </style>
</head>

<body>
  <div class="page-shell">
    <div class="topbar">
      <div class="topbar-left">
        <button class="btn" id="backBtn" type="button">← Back to Equipment</button>
        <button class="btn primary" id="saveBtn" type="button">Save</button>
        <button class="btn good" id="printBtn" type="button">Print / PDF</button>
        <div class="logo" aria-label="NEXUS"></div>

        <div class="title-wrap">
          <h1 class="page-title" id="pageTitle" title="Double-click to toggle Foreman tools">Construction Check Sheet</h1>
          <p class="subtitle" id="equipLine">Equipment: (none)</p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-head">
        <h2>Header</h2>
        <div style="color: rgba(17,19,24,.70); font-weight:900; font-size:12px;" id="statusLine">Not saved</div>
      </div>

      <div class="grid cols-4">
        <div class="field">
          <label>Equipment</label>
          <input class="input" id="hdrEquipment" placeholder="TR-001" />
        </div>
        <div class="field">
          <label>Building Number</label>
          <input class="input" id="hdrBuilding" placeholder="Enter..." />
        </div>
        <div class="field">
          <label>Phase</label>
          <input class="input" id="hdrPhase" placeholder="Enter..." />
        </div>
        <div class="field">
          <label>Equip ID</label>
          <input class="input" id="hdrEquipId" placeholder="Enter..." />
        </div>

        <div class="field" style="grid-column: 1 / -1;">
          <label>Foreman</label>
          <input class="input" id="hdrForeman" placeholder="Enter..." />
        </div>
      </div>

      <div class="muteline" id="storageKeyLine">Storage key: —</div>

      <div class="section-head">
        <h2>Construction Items</h2>
        <div style="display:flex; gap:10px; align-items:center;">
          <div style="font-weight:900; font-size:12px; color: rgba(17,19,24,.70);" id="rowCount">0 rows</div>
        </div>
      </div>

      <div class="table-wrap">
        <table id="sheetTable" aria-label="Construction Check Sheet">
          <thead>
            <tr>
              <th class="col-num">#</th>
              <th class="col-item">Construction Items</th>
              <th class="col-notes">Notes</th>
              <th class="col-sign" colspan="2">Construction</th>
              <th class="col-sign" colspan="2">QCx</th>
              <th class="col-actions" colspan="2">Row</th>
            </tr>
            <tr>
              <th class="col-num"></th>
              <th class="col-item"></th>
              <th class="col-notes"></th>
              <th class="col-sign">Sign Off</th>
              <th class="col-date">Date</th>
              <th class="col-sign">Sign Off</th>
              <th class="col-date">Date</th>
              <th class="col-actions">+</th>
              <th class="col-actions">×</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="section-head">
        <h2>Final Sign-Off</h2>
        <div style="color: rgba(17,19,24,.70); font-weight:900; font-size:12px;">Required</div>
      </div>

      <div class="grid cols-4" style="padding-bottom: 18px;">
        <div class="field" style="grid-column: 1 / 3;">
          <label>Construction Foreman Name <span style="color: var(--warn);">(required)</span></label>
          <input class="input" id="finalConstName" placeholder="Enter..." data-required="1" />
        </div>
        <div class="field" style="grid-column: 3 / 5;">
          <label>QCx Foreman Name <span style="color: var(--warn);">(required)</span></label>
          <input class="input" id="finalQcxName" placeholder="Enter..." data-required="1" />
        </div>
        <div class="field" style="grid-column: 1 / 3;">
          <label>Date <span style="color: var(--warn);">(required)</span></label>
          <input class="input" id="finalDate" type="date" data-required="1" />
        </div>
        <div class="field" style="grid-column: 3 / 5;">
          <label>Notes (optional)</label>
          <textarea class="textarea" id="finalNotes" placeholder="Optional..." rows="2"></textarea>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**********************
     * Utilities
     **********************/
    const $ = (id) => document.getElementById(id);

    function nowIsoLocalDateTime(){
      const d = new Date();
      const pad = (n) => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function downloadText(filename, text, mime="text/plain"){
      const blob = new Blob([text], {type: mime});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 500);
    }

    function toCSV(data){
      const headers = [
        "rowType","item","notes",
        "constructionSignOff","constructionDate",
        "qcxSignOff","qcxDate"
      ];
      const esc = (v) => {
        const s = (v ?? "").toString();
        if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      };
      const lines = [];
      lines.push(headers.join(","));
      for (const r of data.rows){
        lines.push(headers.map(h => esc(r[h])).join(","));
      }
      return lines.join("\n");
    }

    function autoGrowTextarea(el){
      if (!el) return;
      el.style.height = "auto";
      el.style.height = Math.min(el.scrollHeight, 420) + "px";
    }

    function setStatus(text, ok=false){
      const el = $("statusLine");
      el.textContent = text;
      el.style.color = ok ? "rgba(37,192,109,.95)" : "rgba(17,19,24,.70)";
    }

    /**********************
     * Role gating (Foreman only add/delete)
     **********************/
    const ROLE_KEY = "nexus_role";
    const DEFAULT_PIN = "1234";

    function isForeman(){
      const urlRole = new URLSearchParams(location.search).get("role");
      if (urlRole && urlRole.toLowerCase() === "foreman") return true;
      return localStorage.getItem(ROLE_KEY) === "foreman";
    }
    function setForeman(on){
      if (on) localStorage.setItem(ROLE_KEY, "foreman");
      else localStorage.removeItem(ROLE_KEY);
      document.documentElement.classList.toggle("is-foreman", isForeman());
      render();
    }
    document.documentElement.classList.toggle("is-foreman", isForeman());

    $("pageTitle").addEventListener("dblclick", () => {
      const pin = prompt("Enter Foreman PIN:");
      if (pin === null) return;
      const expected = localStorage.getItem("nexus_foreman_pin") || DEFAULT_PIN;
      if (pin === expected){
        setForeman(!isForeman());
      } else {
        alert("Incorrect PIN.");
      }
    });

    /**********************
     * Routing / Keys
     **********************/
    const params = new URLSearchParams(window.location.search);
    const eqParam = params.get("eq") || "";
    $("hdrEquipment").value = eqParam || "";
    $("hdrEquipId").value = eqParam || "";
    $("equipLine").textContent = eqParam ? ("Equipment: " + eqParam) : "Equipment: (none)";

    const backUrl = "equipment.html" + (eqParam ? ("?eq=" + encodeURIComponent(eqParam)) : "");
    $("backBtn").addEventListener("click", () => location.href = backUrl);

    function storageKey(){
      const eq = $("hdrEquipment").value.trim() || eqParam || "UNKNOWN";
      return `nexus/equipment/${eq}/construction/ConstructionCheckSheet`;
    }
    function refreshStorageKeyLine(){
      $("storageKeyLine").textContent = "Storage key: " + storageKey();
    }
    refreshStorageKeyLine();

    $("hdrEquipment").addEventListener("input", () => {
      $("equipLine").textContent = $("hdrEquipment").value.trim() ? ("Equipment: " + $("hdrEquipment").value.trim()) : "Equipment: (none)";
      refreshStorageKeyLine();
      markDirty();
    });

    /**********************
     * Data Model
     **********************/
    const DEFAULT_ROWS = [
      { rowType:"item", item:"LV Transformer 001", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Building Number", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Phase", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Foreman:", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },

      { rowType:"section", item:"Equipment Information", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"RIF Completed", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Labels installed by QCX:", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Phenolic", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Arc Flash", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },

      { rowType:"handoff", item:"QCX (Sign-Off / Pass to Next Stage)", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },

      { rowType:"section", item:"Equipment Mounted / Installation Specs", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"6\" clearance from walls and panels", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Remove front cover bolts, bag & tag, leaving proper amount of bolts to hold cover in place", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Shipping assembly (if required)", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Apply proper cover for equipment protection", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Anchored using 1/2\" concrete wedge anchors", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Housing is mounted squared and leveled", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"XFMR Neta Tested (validated by QCx)", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },

      { rowType:"handoff", item:"QCX Handoff to Construction", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },

      { rowType:"section", item:"Internal Wiring and Termination Specifications", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },

      { rowType:"section", item:"1. Hardware Installation", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Install proper/correct phase lugs (with min 1\" gap from nearest item)", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Install proper ground bar (if required)", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },

      { rowType:"section", item:"2. Primary / High Side", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Primary wire matches 1 Line Diagram: (3) AL #1/0 and 1 CU #6 Ground (A100.3)", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Verify primary wire phase color: H1/A-Brown H2/B-Orange H3/C-Yellow Ground-Green", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Verify installation and termination of ground bonding bushing", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },

      { rowType:"section", item:"3. Secondary / Low Side", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Secondary wire matches 1 Line Diagram: (3) AL #1/0 and Ground 1 CU #8 (A100.3) Neutral wire AL #1/0 (A110.T)", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Verify secondary wire phase color: X1/A-Black X2/B-Red X3/C-Blue Ground-Green Neutral-White", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Verify installation and termination of ground bonding bushing", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },

      { rowType:"section", item:"4. Building Steel", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Verify that ground is #8 copper or larger", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },

      { rowType:"section", item:"5. Bonding Jumper", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"item", item:"Bonding jumper must be AL #1/0 wire (or the same size as biggest conductor on pri. or sec.) and all black", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },

      { rowType:"section", item:"6. Verify hardware kit matches attached inventory sheet", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },
      { rowType:"section", item:"7. Install front cover with all hardware", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" },

      { rowType:"handoff", item:"Foreman in charge verify all complete and handoff to QCX", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" }
    ];

    let state = {
      meta: {
        equipment: $("hdrEquipment").value.trim(),
        building: "",
        phase: "",
        equipId: $("hdrEquipId").value.trim(),
        foreman: ""
      },
      final: {
        constructionForemanName: "",
        qcxForemanName: "",
        date: "",
        notes: ""
      },
      rows: structuredClone(DEFAULT_ROWS)
    };

    let baseline = null;
    let dirty = false;

    function markDirty(){
      dirty = true;
      if (baseline) setStatus("Unsaved changes", false);
      else setStatus("Not saved", false);
    }

    /**********************
     * Render
     **********************/
    function render(){
      const tbody = $("tbody");
      tbody.innerHTML = "";

      state.meta.equipment = $("hdrEquipment").value.trim();
      state.meta.building = $("hdrBuilding").value;
      state.meta.phase = $("hdrPhase").value;
      state.meta.equipId = $("hdrEquipId").value;
      state.meta.foreman = $("hdrForeman").value;

      $("rowCount").textContent = `${state.rows.length} rows`;

      state.rows.forEach((r, idx) => {
        const tr = document.createElement("tr");
        tr.dataset.idx = idx;

        if (r.rowType === "handoff") tr.classList.add("handoff");
        if (r.rowType === "section") tr.classList.add("section-row");

        const tdNum = document.createElement("td");
        tdNum.className = "col-num";
        tdNum.textContent = String(idx + 1);
        tdNum.setAttribute("data-label", "#");
        tr.appendChild(tdNum);

        const tdItem = document.createElement("td");
        tdItem.className = "col-item";
        tdItem.setAttribute("data-label", "Construction Items");

        const itemDiv = document.createElement("div");
        itemDiv.className = "cell-edit";
        itemDiv.contentEditable = (r.rowType !== "section");
        itemDiv.spellcheck = false;
        itemDiv.innerText = r.item || "";

        if (r.rowType === "handoff"){
          itemDiv.classList.add("handoff-label");
        }

        itemDiv.addEventListener("input", () => {
          r.item = itemDiv.innerText.replace(/\u00A0/g, " ");
          markDirty();
          applyChangedStyling();
        });
        itemDiv.addEventListener("keydown", (e) => handleNavKeys(e, itemDiv));
        tdItem.appendChild(itemDiv);
        tr.appendChild(tdItem);

        const tdNotes = document.createElement("td");
        tdNotes.className = "col-notes cell-note";
        tdNotes.setAttribute("data-label", "Notes");

        const notes = document.createElement("textarea");
        notes.className = "textarea";
        notes.placeholder = "Enter notes...";
        notes.value = r.notes || "";
        notes.addEventListener("input", () => {
          r.notes = notes.value;
          autoGrowTextarea(notes);
          markDirty();
          applyChangedStyling();
        });
        notes.addEventListener("keydown", (e) => handleNavKeys(e, notes));
        tdNotes.appendChild(notes);
        tr.appendChild(tdNotes);

        tr.appendChild(makeSmallInputCell("Construction Sign Off", "col-sign", r, "constructionSignOff", "Initials...", "text"));
        tr.appendChild(makeSmallInputCell("Construction Date", "col-date", r, "constructionDate", "", "date"));

        tr.appendChild(makeSmallInputCell("QCx Sign Off", "col-sign", r, "qcxSignOff", "Initials...", "text"));
        tr.appendChild(makeSmallInputCell("QCx Date", "col-date", r, "qcxDate", "", "date"));

        const tdAdd = document.createElement("td");
        tdAdd.className = "col-actions";
        tdAdd.setAttribute("data-label", "Add Row");
        const addBtn = document.createElement("button");
        addBtn.className = "action-btn add foreman-only";
        addBtn.type = "button";
        addBtn.title = "Add row below";
        addBtn.textContent = "+";
        addBtn.addEventListener("click", () => insertRowBelow(idx));
        tdAdd.appendChild(addBtn);
        tr.appendChild(tdAdd);

        const tdDel = document.createElement("td");
        tdDel.className = "col-actions";
        tdDel.setAttribute("data-label", "Delete Row");
        const delBtn = document.createElement("button");
        delBtn.className = "action-btn del foreman-only";
        delBtn.type = "button";
        delBtn.title = "Delete row";
        delBtn.textContent = "×";
        delBtn.addEventListener("click", () => deleteRow(idx));
        tdDel.appendChild(delBtn);
        tr.appendChild(tdDel);

        tbody.appendChild(tr);

        autoGrowTextarea(notes);
      });

      document.documentElement.classList.toggle("is-foreman", isForeman());
      applyChangedStyling();
    }

    function makeSmallInputCell(label, className, rowObj, key, placeholder, type){
      const td = document.createElement("td");
      td.className = className;
      td.setAttribute("data-label", label);

      const inp = document.createElement("input");
      inp.className = "small";
      inp.type = type;
      inp.placeholder = placeholder || "";
      inp.value = rowObj[key] || "";

      inp.addEventListener("input", () => {
        rowObj[key] = inp.value;
        markDirty();
        applyChangedStyling();
      });
      inp.addEventListener("keydown", (e) => handleNavKeys(e, inp));

      td.appendChild(inp);
      return td;
    }

    /**********************
     * Row add/delete (Foreman only)
     **********************/
    function insertRowBelow(idx){
      if (!isForeman()){ alert("Foreman only."); return; }
      state.rows.splice(idx + 1, 0, { rowType:"item", item:"", notes:"", constructionSignOff:"", constructionDate:"", qcxSignOff:"", qcxDate:"" });
      markDirty();
      render();
      focusRowCell(idx + 1, 1);
    }

    function deleteRow(idx){
      if (!isForeman()){ alert("Foreman only."); return; }
      if (!confirm("Delete this row?")) return;
      state.rows.splice(idx, 1);
      markDirty();
      render();
    }

    function focusRowCell(rowIdx, cellIndex){
      const tr = $("tbody").querySelector(`tr[data-idx="${rowIdx}"]`);
      if (!tr) return;
      const tds = tr.querySelectorAll("td");
      const td = tds[cellIndex];
      if (!td) return;
      const focusable = td.querySelector("textarea, input, [contenteditable='true']");
      if (focusable) focusable.focus();
    }

    /**********************
     * Navigation: Enter to next cell
     **********************/
    function handleNavKeys(e, el){
      if (e.key === "Enter"){
        if (el.tagName === "TEXTAREA" && !e.shiftKey && !e.ctrlKey && !e.metaKey){
          e.preventDefault();
          focusNextCell(el, +1);
          return;
        }
        if (el.isContentEditable){
          e.preventDefault();
          focusNextCell(el, +1);
          return;
        }
      }
      if (e.key === "Enter" && e.shiftKey && el.tagName !== "TEXTAREA"){
        e.preventDefault();
        focusNextCell(el, -1);
        return;
      }
    }

    function focusNextCell(el, dir){
      const td = el.closest("td");
      const tr = el.closest("tr");
      if (!td || !tr) return;
      const rowIdx = parseInt(tr.dataset.idx, 10);
      const tds = Array.from(tr.querySelectorAll("td"));
      const col = tds.indexOf(td);

      const focusCols = [1,2,3,4,5,6];
      const focusPos = focusCols.indexOf(col);
      if (focusPos === -1) return;

      let nextPos = focusPos + dir;
      let nextRow = rowIdx;

      if (nextPos < 0){ nextRow = rowIdx - 1; nextPos = focusCols.length - 1; }
      if (nextPos >= focusCols.length){ nextRow = rowIdx + 1; nextPos = 0; }

      if (nextRow < 0) return;
      if (nextRow >= state.rows.length) return;

      focusRowCell(nextRow, focusCols[nextPos]);
    }

    /**********************
     * Change highlighting
     **********************/
    function applyChangedStyling(){
      if (!baseline) return;

      const headerMap = [
        ["hdrBuilding", baseline.meta.building],
        ["hdrPhase", baseline.meta.phase],
        ["hdrEquipId", baseline.meta.equipId],
        ["hdrForeman", baseline.meta.foreman],
        ["finalConstName", baseline.final.constructionForemanName],
        ["finalQcxName", baseline.final.qcxForemanName],
        ["finalDate", baseline.final.date],
        ["finalNotes", baseline.final.notes]
      ];
      headerMap.forEach(([id, baseVal]) => {
        const el = $(id);
        const v = (el.value ?? "");
        el.classList.toggle("changed", v !== (baseVal ?? ""));
      });

      const tbody = $("tbody");
      const trs = tbody.querySelectorAll("tr");
      trs.forEach((tr) => {
        const idx = parseInt(tr.dataset.idx,10);
        const row = state.rows[idx];
        const base = baseline.rows[idx];

        if (!base){
          tr.querySelectorAll(".cell-edit, .textarea, .small").forEach(x => x.classList.add("changed"));
          return;
        }

        const itemDiv = tr.querySelector(".cell-edit");
        const note = tr.querySelector("textarea");
        const inputs = tr.querySelectorAll("input.small");
        if (itemDiv) itemDiv.classList.toggle("changed", (row.item ?? "") !== (base.item ?? ""));
        if (note) note.classList.toggle("changed", (row.notes ?? "") !== (base.notes ?? ""));
        if (inputs[0]) inputs[0].classList.toggle("changed", (row.constructionSignOff ?? "") !== (base.constructionSignOff ?? ""));
        if (inputs[1]) inputs[1].classList.toggle("changed", (row.constructionDate ?? "") !== (base.constructionDate ?? ""));
        if (inputs[2]) inputs[2].classList.toggle("changed", (row.qcxSignOff ?? "") !== (base.qcxSignOff ?? ""));
        if (inputs[3]) inputs[3].classList.toggle("changed", (row.qcxDate ?? "") !== (base.qcxDate ?? ""));
      });
    }

    /**********************
     * Validation (Required fields + handoff rows)
     **********************/
    function clearValidationUI(){
      document.querySelectorAll(".invalid").forEach(el => el.classList.remove("invalid"));
    }

    function validateAll(){
      clearValidationUI();
      let ok = true;

      ["finalConstName", "finalQcxName", "finalDate"].forEach((id) => {
        const el = $(id);
        const v = (el.value || "").trim();
        if (!v){ el.classList.add("invalid"); ok = false; }
      });

      const trs = $("tbody").querySelectorAll("tr");
      trs.forEach((tr) => {
        const idx = parseInt(tr.dataset.idx,10);
        const row = state.rows[idx];
        if (row.rowType !== "handoff") return;

        const inputs = tr.querySelectorAll("input.small");
        const must = [inputs[0], inputs[1], inputs[2], inputs[3]];
        must.forEach((el) => {
          if (!el) return;
          if (!(el.value || "").trim()){
            el.classList.add("invalid");
            ok = false;
          }
        });
      });

      if (!ok){
        alert("Missing required fields. Please complete highlighted fields (hand-off rows + Final Sign-Off).");
      }
      return ok;
    }

    /**********************
     * Save/Load (Firebase if available, else localStorage)
     **********************/
    function localKey(){
      const eq = ($("hdrEquipment").value.trim() || eqParam || "UNKNOWN").replace(/[^\w\-]/g, "_");
      return `NEXUS_CCS_${eq}`;
    }

    function snapshot(){
      state.meta = {
        equipment: $("hdrEquipment").value.trim(),
        building: $("hdrBuilding").value,
        phase: $("hdrPhase").value,
        equipId: $("hdrEquipId").value,
        foreman: $("hdrForeman").value
      };
      state.final = {
        constructionForemanName: $("finalConstName").value,
        qcxForemanName: $("finalQcxName").value,
        date: $("finalDate").value,
        notes: $("finalNotes").value
      };
      return {
        version: "1.0",
        kind: "construction_check_sheet",
        savedAt: nowIsoLocalDateTime(),
        storageKey: storageKey(),
        meta: structuredClone(state.meta),
        final: structuredClone(state.final),
        rows: structuredClone(state.rows)
      };
    }

    async function tryFirebaseSave(doc){
      const key = doc.storageKey;
      const candidates = [
        window?.nexusFirebaseBridge,
        window?.NEXUS_FIREBASE,
        window?.FirebaseBridge,
        window?.nexusFirebase,
        window?.NexusFirebaseBridge
      ].filter(Boolean);

      for (const c of candidates){
        const fn = c.save || c.saveDoc || c.write || c.put || c.set;
        if (typeof fn === "function"){
          await fn.call(c, key, doc);
          return true;
        }
      }
      return false;
    }

    async function tryFirebaseLoad(key){
      const candidates = [
        window?.nexusFirebaseBridge,
        window?.NEXUS_FIREBASE,
        window?.FirebaseBridge,
        window?.nexusFirebase,
        window?.NexusFirebaseBridge
      ].filter(Boolean);

      for (const c of candidates){
        const fn = c.load || c.loadDoc || c.read || c.get || c.fetch;
        if (typeof fn === "function"){
          const doc = await fn.call(c, key);
          if (doc) return doc;
        }
      }
      return null;
    }

    async function save(){
      if (!validateAll()) return;

      const doc = snapshot();

      localStorage.setItem(localKey(), JSON.stringify(doc));

      try{
        const did = await tryFirebaseSave(doc);
        setStatus(did ? "Saved (Firebase + local)" : "Saved (local)", true);
      } catch (e){
        setStatus("Saved (local) - Firebase error", false);
      }

      baseline = structuredClone(doc);
      dirty = false;
      applyChangedStyling();
    }

    async function load(){
      const key = storageKey();
      let doc = null;

      try{ doc = await tryFirebaseLoad(key); } catch(e){ doc = null; }

      if (!doc){
        const raw = localStorage.getItem(localKey());
        if (raw){
          try{ doc = JSON.parse(raw); } catch(e){ doc = null; }
        }
      }

      if (doc && doc.rows && Array.isArray(doc.rows)){
        $("hdrEquipment").value = doc.meta?.equipment || $("hdrEquipment").value || "";
        $("hdrBuilding").value = doc.meta?.building || "";
        $("hdrPhase").value = doc.meta?.phase || "";
        $("hdrEquipId").value = doc.meta?.equipId || "";
        $("hdrForeman").value = doc.meta?.foreman || "";

        $("finalConstName").value = doc.final?.constructionForemanName || "";
        $("finalQcxName").value = doc.final?.qcxForemanName || "";
        $("finalDate").value = doc.final?.date || "";
        $("finalNotes").value = doc.final?.notes || "";

        state.rows = doc.rows;
        baseline = structuredClone(doc);
        dirty = false;
        setStatus("Loaded", true);
        refreshStorageKeyLine();
        $("equipLine").textContent = ($("hdrEquipment").value.trim()) ? ("Equipment: " + $("hdrEquipment").value.trim()) : "Equipment: (none)";
      } else {
        state.rows = structuredClone(DEFAULT_ROWS);
        setStatus("No saved sheet found (using template)", false);
      }

      render();
    }

    /**********************
     * Exports (hotkeys)
     *  - Ctrl+J: JSON
     *  - Ctrl+E: CSV
     **********************/
    function exportJSON(){
      const doc = snapshot();
      downloadText(`ConstructionCheckSheet_${(doc.meta.equipment||"UNKNOWN")}.json`, JSON.stringify(doc, null, 2), "application/json");
    }
    function exportCSV(){
      const doc = snapshot();
      const csv = toCSV(doc);
      downloadText(`ConstructionCheckSheet_${(doc.meta.equipment||"UNKNOWN")}.csv`, csv, "text/csv");
    }

    window.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s"){ e.preventDefault(); save(); }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "j"){ e.preventDefault(); exportJSON(); }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "e"){ e.preventDefault(); exportCSV(); }
    });

    /**********************
     * Wire inputs -> dirty + highlight
     **********************/
    ["hdrBuilding","hdrPhase","hdrEquipId","hdrForeman","finalConstName","finalQcxName","finalDate","finalNotes"].forEach((id) => {
      $(id).addEventListener("input", () => { markDirty(); applyChangedStyling(); });
    });

    $("saveBtn").addEventListener("click", save);
    $("printBtn").addEventListener("click", () => {
      if (!validateAll()) return;
      window.print();
    });

    /**********************
     * Init
     **********************/
    (async function init(){
      if (eqParam){
        $("hdrEquipment").value = eqParam;
        $("hdrEquipId").value = eqParam;
        $("equipLine").textContent = "Equipment: " + eqParam;
      }
      await load();
    })();
  </script>
</body>
</html>
